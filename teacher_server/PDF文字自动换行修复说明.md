# PDF文字自动换行修复说明

## 问题描述
在PDF导出功能中，部分长文本内容超出了表格边框，显示不完整。

## 问题原因
在生成PDF时，表格单元格中的文本是直接以字符串形式插入的，没有使用 `Paragraph` 对象进行包裹。reportlab库在处理纯文本时不会自动换行，导致长文本溢出。

## 解决方案
将所有可能包含长文本的单元格内容都用 `Paragraph` 对象包裹，并设置以下属性：
- `wordWrap='CJK'`：支持中文、日文、韩文的自动换行
- `leading`：设置合适的行间距
- `fontSize`：根据内容重要性设置字体大小

## 已修复的部分

### 1. 茶助教问答记录（最关键）
**修改位置**：`_add_chat_messages()` 方法

**修改内容**：
- 为每条对话消息创建 `Paragraph` 对象
- 设置 `wordWrap='CJK'` 支持中文换行
- 使用HTML标签 `<b>` 加粗角色名称

**效果**：学生提问和AI回答的长文本都能正确换行显示

### 2. 任务一 - 感官记录表格
**修改位置**：`_add_task1()` 方法中的感官记录部分

**修改内容**：
- 为所有单元格（色泽、香气、形状、滋味）创建 `Paragraph` 对象
- 设置居中对齐 `alignment=TA_CENTER`
- 字体大小设为 9pt，确保在小单元格中也能正常显示

**效果**：干茶、茶汤、叶底的描述文字能自动换行

### 3. 任务一 - 茶品信息表格
**修改位置**：`_add_task1()` 方法中的茶品信息部分

**修改内容**：
- 为茶品名、老师茶品名、茶类、水温、冲泡时长等字段创建 `Paragraph` 对象
- 字体大小设为 10pt

**效果**：较长的茶品名称和描述能正常换行

### 4. 任务二 - 冲泡信息表格
**修改位置**：`_add_task2()` 方法

**修改内容**：
- 为茶品名、水温、出汤时长、色泽、香气、滋味等字段创建 `Paragraph` 对象
- 特别优化了"茶汤的色泽"、"茶汤的香气"、"茶汤的滋味"这些可能包含长描述的字段

**效果**：学生对茶汤的详细描述能完整显示

## 技术细节

### Paragraph样式配置
```python
ParagraphStyle(
    'StyleName',
    parent=self.body_style,
    fontName='Chinese',      # 使用中文字体
    fontSize=10,             # 字体大小
    leading=14,              # 行间距（通常为字体大小的1.2-1.4倍）
    wordWrap='CJK',          # 启用中日韩文字的自动换行
    alignment=TA_CENTER      # 对齐方式（可选）
)
```

### 为什么需要wordWrap='CJK'？
中文、日文、韩文的换行规则与英文不同：
- 英文：在空格或连字符处换行
- 中文：可以在任意字符间换行

设置 `wordWrap='CJK'` 后，reportlab会按照东亚文字的规则进行换行。

## 测试建议
1. ✅ 导出包含长文本对话的小组PDF
2. ✅ 检查茶助教对话记录是否正确换行
3. ✅ 检查任务一、任务二的表格内容是否完整显示
4. ✅ 检查没有文字溢出边框

## 注意事项
- 修改后需要重启服务器才能生效
- 如果仍有部分内容溢出，可以调整 `colWidths`（列宽）参数
- 行间距 `leading` 可以根据实际效果微调

## 更新日期
2025-12-31

