# 茶文化课程APP - 数据库设计方案

## 一、数据结构分析

### 1.1 学生基本信息
- 学校 (school)
- 年级 (grade: 高一/高二)
- 班级 (classNumber: 数字)
- 日期 (date: yyyy-MM-dd)
- 小组成员 (1-10人，每个成员有姓名)

### 1.2 任务一数据
- 茶品信息：茶品名、老师茶品名、茶类、水温、冲泡时长
- 感官记录表格：
  - 干茶：色泽、香气、形状、滋味
  - 茶汤：色泽、香气、形状、滋味
  - 叶底：色泽、香气、形状、滋味
- 思考题答案
- 照片（多张）

### 1.3 任务二数据
- 茶品信息：茶品名、水温、出汤时长
- 茶汤特点：色泽、香气、滋味
- 是否符合预期：符合/不符合（布尔值）
- 思考题答案
- 照片（多张）

### 1.4 思考题一、二数据
- 答案（文本）
- 照片（多张）

### 1.5 创意题数据
- 答案（文本）
- 照片（多张）

## 二、数据库设计原则

### 2.1 设计原则
1. **规范化设计**：减少数据冗余，提高数据一致性
2. **可扩展性**：使用JSON字段存储灵活数据，便于后续添加字段
3. **版本控制**：添加版本字段，支持数据结构变更
4. **照片分离**：照片文件单独存储，数据库只存储路径
5. **时间戳**：记录提交时间，便于查询和排序

### 2.2 技术选型
- **数据库**：SQLite（轻量级，适合单机部署）或 PostgreSQL（功能强大，适合多用户）
- **ORM**：SQLAlchemy（Python，便于数据库操作和迁移）
- **Web框架**：Flask（轻量级，易于开发）或 FastAPI（现代化，性能好）

## 三、数据库表结构设计

### 3.1 学生组表 (student_groups)
```sql
CREATE TABLE student_groups (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    submission_id VARCHAR(64) UNIQUE NOT NULL,  -- 提交ID（学校_年级_班级_时间戳）
    school VARCHAR(100) NOT NULL,                -- 学校
    grade VARCHAR(10) NOT NULL,                  -- 年级（高一/高二）
    class_number VARCHAR(10) NOT NULL,           -- 班级号
    activity_date DATE NOT NULL,                 -- 活动日期
    member_count INTEGER NOT NULL,               -- 小组成员人数
    submit_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,  -- 提交时间
    version VARCHAR(10) DEFAULT '1.0',           -- 数据结构版本
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

### 3.2 小组成员表 (group_members)
```sql
CREATE TABLE group_members (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    group_id INTEGER NOT NULL,                  -- 关联student_groups.id
    member_index INTEGER NOT NULL,               -- 成员序号（1-10）
    member_name VARCHAR(50) NOT NULL,            -- 成员姓名
    FOREIGN KEY (group_id) REFERENCES student_groups(id) ON DELETE CASCADE,
    UNIQUE(group_id, member_index)
);
```

### 3.3 任务一数据表 (task1_data)
```sql
CREATE TABLE task1_data (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    group_id INTEGER NOT NULL UNIQUE,           -- 关联student_groups.id
    -- 茶品信息
    tea_name VARCHAR(100),                       -- 茶品名
    teacher_tea_name VARCHAR(100),               -- 老师茶品名
    tea_category VARCHAR(50),                    -- 茶类
    water_temperature VARCHAR(20),               -- 水温（带单位）
    brewing_duration VARCHAR(50),                -- 冲泡时长
    -- 感官记录（使用JSON存储，便于扩展）
    sensory_records TEXT,                        -- JSON格式：{"dryTea": {...}, "teaLiquor": {...}, "spentLeaves": {...}}
    -- 思考题
    reflection_answer TEXT,                      -- 思考题答案
    -- 元数据
    submit_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    version VARCHAR(10) DEFAULT '1.0',
    FOREIGN KEY (group_id) REFERENCES student_groups(id) ON DELETE CASCADE
);
```

### 3.4 任务二数据表 (task2_data)
```sql
CREATE TABLE task2_data (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    group_id INTEGER NOT NULL UNIQUE,           -- 关联student_groups.id
    -- 茶品信息
    tea_name VARCHAR(100),                       -- 茶品名
    water_temperature VARCHAR(20),               -- 水温
    steeping_duration VARCHAR(50),               -- 出汤时长
    -- 茶汤特点
    tea_color VARCHAR(100),                      -- 茶汤色泽
    tea_aroma VARCHAR(100),                       -- 茶汤香气
    tea_taste VARCHAR(100),                      -- 茶汤滋味
    -- 是否符合预期
    meets_expectation BOOLEAN DEFAULT FALSE,     -- 符合预期
    not_meets_expectation BOOLEAN DEFAULT FALSE, -- 不符合预期
    -- 思考题
    reflection_answer TEXT,                      -- 思考题答案
    -- 元数据
    submit_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    version VARCHAR(10) DEFAULT '1.0',
    FOREIGN KEY (group_id) REFERENCES student_groups(id) ON DELETE CASCADE
);
```

### 3.5 思考题数据表 (thinking_questions)
```sql
CREATE TABLE thinking_questions (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    group_id INTEGER NOT NULL,                   -- 关联student_groups.id
    question_type VARCHAR(20) NOT NULL,          -- 题目类型：thinking1/thinking2/creative
    answer TEXT,                                  -- 答案
    submit_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    version VARCHAR(10) DEFAULT '1.0',
    FOREIGN KEY (group_id) REFERENCES student_groups(id) ON DELETE CASCADE,
    UNIQUE(group_id, question_type)
);
```

### 3.6 照片表 (photos)
```sql
CREATE TABLE photos (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    group_id INTEGER NOT NULL,                   -- 关联student_groups.id
    photo_type VARCHAR(20) NOT NULL,             -- 照片类型：task1/task2/thinking1/thinking2/creative/info
    photo_index INTEGER NOT NULL,                -- 照片序号
    file_path VARCHAR(500) NOT NULL,              -- 文件路径（相对路径）
    file_name VARCHAR(200) NOT NULL,              -- 文件名
    file_size INTEGER,                            -- 文件大小（字节）
    upload_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (group_id) REFERENCES student_groups(id) ON DELETE CASCADE
);
```

## 四、JSON字段设计示例

### 4.1 任务一感官记录JSON结构
```json
{
    "dryTea": {
        "color": "色泽描述",
        "aroma": "香气描述",
        "shape": "形状描述",
        "taste": "滋味描述"
    },
    "teaLiquor": {
        "color": "色泽描述",
        "aroma": "香气描述",
        "shape": "形状描述",
        "taste": "滋味描述"
    },
    "spentLeaves": {
        "color": "色泽描述",
        "aroma": "香气描述",
        "shape": "形状描述",
        "taste": "滋味描述"
    }
}
```

## 五、扩展性设计

### 5.1 版本控制
- 每个表都有 `version` 字段
- 当数据结构变更时，可以：
  1. 保持旧版本数据兼容
  2. 新版本使用新的JSON结构
  3. 通过版本号区分不同数据结构

### 5.2 JSON字段优势
- **灵活性**：可以随时添加新字段，无需修改表结构
- **向后兼容**：旧数据仍然可以读取
- **易于迁移**：可以通过脚本将旧数据迁移到新结构

### 5.3 预留扩展字段
- 在关键表中添加 `extra_data TEXT` 字段（JSON格式）
- 用于存储未来可能添加的额外数据

## 六、索引设计

```sql
-- 学生组表索引
CREATE INDEX idx_groups_school ON student_groups(school);
CREATE INDEX idx_groups_grade ON student_groups(grade);
CREATE INDEX idx_groups_class ON student_groups(class_number);
CREATE INDEX idx_groups_date ON student_groups(activity_date);
CREATE INDEX idx_groups_submit_time ON student_groups(submit_time);

-- 照片表索引
CREATE INDEX idx_photos_group ON photos(group_id);
CREATE INDEX idx_photos_type ON photos(photo_type);

-- 思考题表索引
CREATE INDEX idx_thinking_group ON thinking_questions(group_id);
CREATE INDEX idx_thinking_type ON thinking_questions(question_type);
```

## 七、数据迁移策略

### 7.1 版本升级流程
1. 检测当前数据库版本
2. 执行迁移脚本（如需要）
3. 更新版本号
4. 记录迁移日志

### 7.2 迁移脚本示例
```python
# migrations/v1.0_to_v1.1.py
def upgrade():
    # 添加新字段
    # 迁移旧数据
    # 更新版本号
    pass
```

## 八、数据备份策略

1. **定期备份**：每天自动备份数据库
2. **照片备份**：照片文件同步备份
3. **备份存储**：本地 + 云端（可选）

