{% extends "base.html" %}

{% block content %}
<div class="card">
    <h2>学生列表</h2>
    
    <!-- 筛选表单 -->
    <form method="GET" style="margin-top: 20px;">
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
            <div class="form-group">
                <label>学校</label>
                <input type="text" name="school" value="{{ school }}" placeholder="输入学校名称">
            </div>
            <div class="form-group">
                <label>年级</label>
                <select name="grade">
                    <option value="">全部</option>
                    <option value="高一" {% if grade == '高一' %}selected{% endif %}>高一</option>
                    <option value="高二" {% if grade == '高二' %}selected{% endif %}>高二</option>
                </select>
            </div>
            <div class="form-group">
                <label>班级</label>
                <input type="text" name="class_number" value="{{ class_number }}" placeholder="输入班级号">
            </div>
            <div class="form-group">
                <label>开始日期</label>
                <input type="date" name="start_date" value="{{ start_date }}" placeholder="选择开始日期">
            </div>
            <div class="form-group">
                <label>结束日期</label>
                <input type="date" name="end_date" value="{{ end_date }}" placeholder="选择结束日期">
            </div>
            <div class="form-group" style="display: flex; align-items: flex-end;">
                <button type="submit" class="btn">筛选</button>
                <a href="/" class="btn btn-secondary" style="margin-left: 10px;">重置</a>
            </div>
        </div>
    </form>
</div>

<div class="card">
    <table class="table">
        <thead>
            <tr>
                <th>学校</th>
                <th>年级</th>
                <th>班级</th>
                <th>活动日期</th>
                <th>成员人数</th>
                <th>任务一</th>
                <th>任务二</th>
                <th>思考题一</th>
                <th>思考题二</th>
                <th>创意题</th>
                <th>提交时间</th>
                <th>操作</th>
            </tr>
        </thead>
        <tbody>
            {% for student in students %}
            <tr>
                <td>{{ student.school }}</td>
                <td>{{ student.grade }}</td>
                <td>{{ student.class_number }}班</td>
                <td>{{ student.activity_date }}</td>
                <td>{{ student.member_count }}人</td>
                <td style="text-align: center;">
                    {% if student.task1 %}
                        {% set task1_has_content = student.task1.tea_name or student.task1.teacher_tea_name or student.task1.tea_category or student.task1.water_temperature or student.task1.brewing_duration or student.task1.reflection_answer %}
                        {% set task1_records = student.task1.get_sensory_records() %}
                        {% set task1_has_sensory = task1_records.get('dryTea', {}).get('color') or task1_records.get('dryTea', {}).get('aroma') or task1_records.get('teaLiquor', {}).get('color') or task1_records.get('spentLeaves', {}).get('color') %}
                        {% if task1_has_content or task1_has_sensory %}
                            {% set task1_chars = student.get_task1_char_count() %}
                            <span style="color: #4CAF50; font-weight: bold; font-size: 18px;">✓</span>
                            <span style="color: #666; font-size: 12px; margin-left: 4px;">{{ task1_chars }}字</span>
                        {% else %}
                            <span style="color: #F44336; font-weight: bold; font-size: 18px;">✗</span>
                        {% endif %}
                    {% else %}
                        <span style="color: #F44336; font-weight: bold; font-size: 18px;">✗</span>
                    {% endif %}
                </td>
                <td style="text-align: center;">
                    {% if student.task2 %}
                        {% set task2_has_content = student.task2.tea_name or student.task2.water_temperature or student.task2.steeping_duration or student.task2.tea_color or student.task2.tea_aroma or student.task2.tea_taste or student.task2.reflection_answer or student.task2.meets_expectation or student.task2.not_meets_expectation %}
                        {% if task2_has_content %}
                            {% set task2_chars = student.get_task2_char_count() %}
                            <span style="color: #4CAF50; font-weight: bold; font-size: 18px;">✓</span>
                            <span style="color: #666; font-size: 12px; margin-left: 4px;">{{ task2_chars }}字</span>
                        {% else %}
                            <span style="color: #F44336; font-weight: bold; font-size: 18px;">✗</span>
                        {% endif %}
                    {% else %}
                        <span style="color: #F44336; font-weight: bold; font-size: 18px;">✗</span>
                    {% endif %}
                </td>
                <td style="text-align: center;">
                    {% set thinking1 = student.thinking_questions | selectattr('question_type', 'equalto', 'thinking1') | first %}
                    {% if thinking1 and (thinking1.answer and thinking1.answer.strip()) %}
                        {% set thinking1_chars = student.get_thinking_char_count('thinking1') %}
                        <span style="color: #4CAF50; font-weight: bold; font-size: 18px;">✓</span>
                        <span style="color: #666; font-size: 12px; margin-left: 4px;">{{ thinking1_chars }}字</span>
                    {% else %}
                        <span style="color: #F44336; font-weight: bold; font-size: 18px;">✗</span>
                    {% endif %}
                </td>
                <td style="text-align: center;">
                    {% set thinking2 = student.thinking_questions | selectattr('question_type', 'equalto', 'thinking2') | first %}
                    {% if thinking2 and (thinking2.answer and thinking2.answer.strip()) %}
                        {% set thinking2_chars = student.get_thinking_char_count('thinking2') %}
                        <span style="color: #4CAF50; font-weight: bold; font-size: 18px;">✓</span>
                        <span style="color: #666; font-size: 12px; margin-left: 4px;">{{ thinking2_chars }}字</span>
                    {% else %}
                        <span style="color: #F44336; font-weight: bold; font-size: 18px;">✗</span>
                    {% endif %}
                </td>
                <td style="text-align: center;">
                    {% set creative = student.thinking_questions | selectattr('question_type', 'equalto', 'creative') | first %}
                    {% if creative and (creative.answer and creative.answer.strip()) %}
                        {% set creative_chars = student.get_thinking_char_count('creative') %}
                        <span style="color: #4CAF50; font-weight: bold; font-size: 18px;">✓</span>
                        <span style="color: #666; font-size: 12px; margin-left: 4px;">{{ creative_chars }}字</span>
                    {% else %}
                        <span style="color: #F44336; font-weight: bold; font-size: 18px;">✗</span>
                    {% endif %}
                </td>
                <td>{{ student.submit_time.strftime('%Y-%m-%d %H:%M') if student.submit_time else '' }}</td>
                <td>
                    <div style="display: flex; gap: 8px;">
                        <a href="/student/{{ student.submission_id }}" class="btn btn-secondary" style="padding: 6px 12px; font-size: 14px;">查看详情</a>
                        <button onclick="deleteStudent('{{ student.submission_id }}', '{{ student.school }} - {{ student.grade }}{{ student.class_number }}班')" 
                                class="btn" 
                                style="padding: 6px 12px; font-size: 14px; background-color: #F44336; color: white;">
                            删除
                        </button>
                    </div>
                </td>
            </tr>
            {% else %}
            <tr>
                <td colspan="12" style="text-align: center; padding: 40px;">
                    暂无数据
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    
    <!-- 分页 -->
    {% if pagination.pages > 1 %}
    <div class="pagination">
        {% if pagination.has_prev %}
        <a href="?page={{ pagination.prev_num }}{% if school %}&school={{ school }}{% endif %}{% if grade %}&grade={{ grade }}{% endif %}{% if class_number %}&class_number={{ class_number }}{% endif %}{% if start_date %}&start_date={{ start_date }}{% endif %}{% if end_date %}&end_date={{ end_date }}{% endif %}">上一页</a>
        {% endif %}
        
        {% for page_num in pagination.iter_pages(left_edge=1, right_edge=1, left_current=2, right_current=2) %}
            {% if page_num %}
                {% if page_num == pagination.page %}
                <span class="current">{{ page_num }}</span>
                {% else %}
                <a href="?page={{ page_num }}{% if school %}&school={{ school }}{% endif %}{% if grade %}&grade={{ grade }}{% endif %}{% if class_number %}&class_number={{ class_number }}{% endif %}{% if start_date %}&start_date={{ start_date }}{% endif %}{% if end_date %}&end_date={{ end_date }}{% endif %}">{{ page_num }}</a>
                {% endif %}
            {% else %}
                <span>...</span>
            {% endif %}
        {% endfor %}
        
        {% if pagination.has_next %}
        <a href="?page={{ pagination.next_num }}{% if school %}&school={{ school }}{% endif %}{% if grade %}&grade={{ grade }}{% endif %}{% if class_number %}&class_number={{ class_number }}{% endif %}{% if start_date %}&start_date={{ start_date }}{% endif %}{% if end_date %}&end_date={{ end_date }}{% endif %}">下一页</a>
        {% endif %}
    </div>
    {% endif %}
</div>
{% endblock %}

