{% extends "base.html" %}

{% block content %}
<div class="card">
    <h2>å­¦ç”Ÿåˆ—è¡¨</h2>
    
    <!-- ç­›é€‰è¡¨å• -->
    <form method="GET" style="margin-top: 20px;">
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
            <div class="form-group">
                <label>å­¦æ ¡</label>
                <input type="text" name="school" value="{{ school }}" placeholder="è¾“å…¥å­¦æ ¡åç§°">
            </div>
            <div class="form-group">
                <label>å¹´çº§</label>
                <select name="grade">
                    <option value="">å…¨éƒ¨</option>
                    <option value="é«˜ä¸€" {% if grade == 'é«˜ä¸€' %}selected{% endif %}>é«˜ä¸€</option>
                    <option value="é«˜äºŒ" {% if grade == 'é«˜äºŒ' %}selected{% endif %}>é«˜äºŒ</option>
                </select>
            </div>
            <div class="form-group">
                <label>ç­çº§</label>
                <input type="text" name="class_number" value="{{ class_number }}" placeholder="è¾“å…¥ç­çº§å·">
            </div>
            <div class="form-group">
                <label>å¼€å§‹æ—¥æœŸ</label>
                <input type="date" name="start_date" value="{{ start_date }}" placeholder="é€‰æ‹©å¼€å§‹æ—¥æœŸ">
            </div>
            <div class="form-group">
                <label>ç»“æŸæ—¥æœŸ</label>
                <input type="date" name="end_date" value="{{ end_date }}" placeholder="é€‰æ‹©ç»“æŸæ—¥æœŸ">
            </div>
            <div class="form-group" style="display: flex; align-items: flex-end;">
                <button type="submit" class="btn">ç­›é€‰</button>
                <a href="/" class="btn btn-secondary" style="margin-left: 10px;">é‡ç½®</a>
            </div>
        </div>
    </form>
    
    <!-- æ•°æ®å¯¼å‡ºæŒ‰é’® -->
    <div style="margin-top: 20px; padding: 15px; background-color: #F5F5F5; border-radius: 8px; display: flex; align-items: center; justify-content: space-between;">
        <div style="flex: 1;">
            <h3 style="margin: 0 0 5px 0; color: #2E7D32; font-size: 16px;">ğŸ“Š æ•°æ®å¯¼å‡º</h3>
            <p style="margin: 0; color: #666; font-size: 14px;">
                å¯¼å‡ºå½“å‰ç­›é€‰æ¡ä»¶ä¸‹çš„æ‰€æœ‰æ•°æ®ï¼ˆå…± {{ pagination.total }} æ¡è®°å½•ï¼‰
            </p>
        </div>
        <div style="display: flex; gap: 10px;">
            <a href="/export/excel?school={{ school }}&grade={{ grade }}&class_number={{ class_number }}&start_date={{ start_date }}&end_date={{ end_date }}" 
               class="btn" 
               style="background-color: #4CAF50; padding: 10px 20px; font-size: 15px; display: flex; align-items: center; gap: 8px;">
                <span style="font-size: 20px;">ğŸ“Š</span>
                <span>å¯¼å‡ºExcelï¼ˆæ¨èï¼‰</span>
            </a>
            <a href="/export/json?school={{ school }}&grade={{ grade }}&class_number={{ class_number }}&start_date={{ start_date }}&end_date={{ end_date }}" 
               class="btn" 
               style="background-color: #9C27B0; padding: 10px 20px; font-size: 15px; display: flex; align-items: center; gap: 8px;">
                <span style="font-size: 20px;">ğŸ“„</span>
                <span>å¯¼å‡ºJSONï¼ˆAIåˆ†æï¼‰</span>
            </a>
        </div>
    </div>
</div>

<div class="card">
    <table class="table">
        <thead>
            <tr>
                <th>å°ç»„ç¼–å·</th>
                <th>å­¦æ ¡</th>
                <th>å¹´çº§</th>
                <th>ç­çº§</th>
                <th>æ´»åŠ¨æ—¥æœŸ</th>
                <th>æˆå‘˜äººæ•°</th>
                <th>ä»»åŠ¡ä¸€</th>
                <th>ä»»åŠ¡äºŒ</th>
                <th>æ€è€ƒé¢˜ä¸€</th>
                <th>æ€è€ƒé¢˜äºŒ</th>
                <th>åˆ›æ„é¢˜</th>
                <th>æäº¤æ—¶é—´</th>
                <th>æ“ä½œ</th>
            </tr>
        </thead>
        <tbody>
            {% for student in students %}
            <tr>
                <td style="text-align: center; font-weight: bold; color: #2E7D32;">
                    {% if student.group_number %}
                        {{ student.group_number }}
                    {% else %}
                        -
                    {% endif %}
                </td>
                <td>{{ student.school }}</td>
                <td>{{ student.grade }}</td>
                <td>{{ student.class_number }}ç­</td>
                <td>{{ student.activity_date }}</td>
                <td>{{ student.member_count }}äºº</td>
                <td style="text-align: center;">
                    {% if student.task1 %}
                        {% set task1_has_content = student.task1.tea_name or student.task1.teacher_tea_name or student.task1.tea_category or student.task1.water_temperature or student.task1.brewing_duration or student.task1.reflection_answer %}
                        {% set task1_records = student.task1.get_sensory_records() %}
                        {% set task1_has_sensory = task1_records.get('dryTea', {}).get('color') or task1_records.get('dryTea', {}).get('aroma') or task1_records.get('teaLiquor', {}).get('color') or task1_records.get('spentLeaves', {}).get('color') %}
                        {% if task1_has_content or task1_has_sensory %}
                            {% set task1_chars = student.get_task1_char_count() %}
                            <span style="color: #4CAF50; font-weight: bold; font-size: 18px;">âœ“</span>
                            <span style="color: #666; font-size: 12px; margin-left: 4px;">{{ task1_chars }}å­—</span>
                        {% else %}
                            <span style="color: #F44336; font-weight: bold; font-size: 18px;">âœ—</span>
                        {% endif %}
                    {% else %}
                        <span style="color: #F44336; font-weight: bold; font-size: 18px;">âœ—</span>
                    {% endif %}
                </td>
                <td style="text-align: center;">
                    {% if student.task2 %}
                        {% set task2_has_content = student.task2.tea_name or student.task2.water_temperature or student.task2.steeping_duration or student.task2.tea_color or student.task2.tea_aroma or student.task2.tea_taste or student.task2.reflection_answer or student.task2.meets_expectation or student.task2.not_meets_expectation %}
                        {% if task2_has_content %}
                            {% set task2_chars = student.get_task2_char_count() %}
                            <span style="color: #4CAF50; font-weight: bold; font-size: 18px;">âœ“</span>
                            <span style="color: #666; font-size: 12px; margin-left: 4px;">{{ task2_chars }}å­—</span>
                        {% else %}
                            <span style="color: #F44336; font-weight: bold; font-size: 18px;">âœ—</span>
                        {% endif %}
                    {% else %}
                        <span style="color: #F44336; font-weight: bold; font-size: 18px;">âœ—</span>
                    {% endif %}
                </td>
                <td style="text-align: center;">
                    {% set thinking1 = student.thinking_questions | selectattr('question_type', 'equalto', 'thinking1') | first %}
                    {% if thinking1 and (thinking1.answer and thinking1.answer.strip()) %}
                        {% set thinking1_chars = student.get_thinking_char_count('thinking1') %}
                        <span style="color: #4CAF50; font-weight: bold; font-size: 18px;">âœ“</span>
                        <span style="color: #666; font-size: 12px; margin-left: 4px;">{{ thinking1_chars }}å­—</span>
                    {% else %}
                        <span style="color: #F44336; font-weight: bold; font-size: 18px;">âœ—</span>
                    {% endif %}
                </td>
                <td style="text-align: center;">
                    {% set thinking2 = student.thinking_questions | selectattr('question_type', 'equalto', 'thinking2') | first %}
                    {% if thinking2 and (thinking2.answer and thinking2.answer.strip()) %}
                        {% set thinking2_chars = student.get_thinking_char_count('thinking2') %}
                        <span style="color: #4CAF50; font-weight: bold; font-size: 18px;">âœ“</span>
                        <span style="color: #666; font-size: 12px; margin-left: 4px;">{{ thinking2_chars }}å­—</span>
                    {% else %}
                        <span style="color: #F44336; font-weight: bold; font-size: 18px;">âœ—</span>
                    {% endif %}
                </td>
                <td style="text-align: center;">
                    {% set creative = student.thinking_questions | selectattr('question_type', 'equalto', 'creative') | first %}
                    {% if creative and (creative.answer and creative.answer.strip()) %}
                        {% set creative_chars = student.get_thinking_char_count('creative') %}
                        <span style="color: #4CAF50; font-weight: bold; font-size: 18px;">âœ“</span>
                        <span style="color: #666; font-size: 12px; margin-left: 4px;">{{ creative_chars }}å­—</span>
                    {% else %}
                        <span style="color: #F44336; font-weight: bold; font-size: 18px;">âœ—</span>
                    {% endif %}
                </td>
                <td>{{ student.submit_time.strftime('%Y-%m-%d %H:%M') if student.submit_time else '' }}</td>
                <td>
                    <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                        <a href="/student/{{ student.submission_id }}" 
                           class="btn btn-secondary" 
                           style="padding: 6px 12px; font-size: 14px;">
                            æŸ¥çœ‹è¯¦æƒ…
                        </a>
                        <a href="/export/pdf/{{ student.submission_id }}" 
                           class="btn" 
                           style="padding: 6px 12px; font-size: 14px; background-color: #FF5722; color: white;">
                            ğŸ“„ å¯¼å‡ºPDF
                        </a>
                        <button onclick="deleteStudent('{{ student.submission_id }}', '{{ student.school }} - {{ student.grade }}{{ student.class_number }}ç­')" 
                                class="btn" 
                                style="padding: 6px 12px; font-size: 14px; background-color: #F44336; color: white;">
                            åˆ é™¤
                        </button>
                    </div>
                </td>
            </tr>
            {% else %}
            <tr>
                <td colspan="13" style="text-align: center; padding: 40px;">
                    æš‚æ— æ•°æ®
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    
    <!-- åˆ†é¡µ -->
    {% if pagination.pages > 1 %}
    <div class="pagination">
        {% if pagination.has_prev %}
        <a href="?page={{ pagination.prev_num }}{% if school %}&school={{ school }}{% endif %}{% if grade %}&grade={{ grade }}{% endif %}{% if class_number %}&class_number={{ class_number }}{% endif %}{% if start_date %}&start_date={{ start_date }}{% endif %}{% if end_date %}&end_date={{ end_date }}{% endif %}">ä¸Šä¸€é¡µ</a>
        {% endif %}
        
        {% for page_num in pagination.iter_pages(left_edge=1, right_edge=1, left_current=2, right_current=2) %}
            {% if page_num %}
                {% if page_num == pagination.page %}
                <span class="current">{{ page_num }}</span>
                {% else %}
                <a href="?page={{ page_num }}{% if school %}&school={{ school }}{% endif %}{% if grade %}&grade={{ grade }}{% endif %}{% if class_number %}&class_number={{ class_number }}{% endif %}{% if start_date %}&start_date={{ start_date }}{% endif %}{% if end_date %}&end_date={{ end_date }}{% endif %}">{{ page_num }}</a>
                {% endif %}
            {% else %}
                <span>...</span>
            {% endif %}
        {% endfor %}
        
        {% if pagination.has_next %}
        <a href="?page={{ pagination.next_num }}{% if school %}&school={{ school }}{% endif %}{% if grade %}&grade={{ grade }}{% endif %}{% if class_number %}&class_number={{ class_number }}{% endif %}{% if start_date %}&start_date={{ start_date }}{% endif %}{% if end_date %}&end_date={{ end_date }}{% endif %}">ä¸‹ä¸€é¡µ</a>
        {% endif %}
    </div>
    {% endif %}
</div>
{% endblock %}

