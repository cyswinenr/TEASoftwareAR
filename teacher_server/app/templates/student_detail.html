{% extends "base.html" %}

{% block title %}å­¦ç”Ÿè¯¦æƒ… - {{ group.school }} {{ group.grade }}{{ group.class_number }}ç­{% endblock %}

{% block content %}
<div class="card">
    <h2>å­¦ç”ŸåŸºæœ¬ä¿¡æ¯</h2>
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 15px;">
        <div>
            <strong>å°ç»„ç¼–å·ï¼š</strong>
            {% if group.group_number %}
                <span style="font-weight: bold; color: #2E7D32; font-size: 18px;">{{ group.group_number }}</span>
            {% else %}
                <span style="color: #999;">æœªè®¾ç½®</span>
            {% endif %}
        </div>
        <div>
            <strong>å­¦æ ¡ï¼š</strong>{{ group.school }}
        </div>
        <div>
            <strong>å¹´çº§ï¼š</strong>{{ group.grade }}
        </div>
        <div>
            <strong>ç­çº§ï¼š</strong>{{ group.class_number }}ç­
        </div>
        <div>
            <strong>æ´»åŠ¨æ—¥æœŸï¼š</strong>{{ group.activity_date }}
        </div>
        <div>
            <strong>æˆå‘˜äººæ•°ï¼š</strong>{{ group.member_count }}äºº
        </div>
        <div>
            <strong>æäº¤æ—¶é—´ï¼š</strong>{{ group.submit_time.strftime('%Y-%m-%d %H:%M:%S') if group.submit_time else '' }}
        </div>
    </div>
    
    <h3 style="margin-top: 20px;">å°ç»„æˆå‘˜</h3>
    <div style="margin-top: 10px;">
        {% for member in group.members %}
        <span style="display: inline-block; padding: 8px 16px; margin: 5px; background-color: #E8F5E9; border-radius: 6px;">
            {{ member.member_index }}. {{ member.member_name }}
        </span>
        {% endfor %}
    </div>
</div>

{% if group.task1 %}
<div class="card">
    <h2>ä»»åŠ¡ä¸€ï¼šæ³¡èŒ¶ä½“éªŒã€å“èŒ¶æ—¶åˆ»</h2>
    
    <h3 style="margin-top: 20px;">èŒ¶å“ä¿¡æ¯</h3>
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 10px;">
        <div><strong>èŒ¶å“åï¼š</strong>{{ group.task1.tea_name or 'æœªå¡«å†™' }}</div>
        <div><strong>è€å¸ˆèŒ¶å“åï¼š</strong>{{ group.task1.teacher_tea_name or 'æœªå¡«å†™' }}</div>
        <div><strong>èŒ¶ç±»ï¼š</strong>{{ group.task1.tea_category or 'æœªå¡«å†™' }}</div>
        <div><strong>æ°´æ¸©ï¼š</strong>{{ group.task1.water_temperature or 'æœªå¡«å†™' }}</div>
        <div><strong>å†²æ³¡æ—¶é•¿ï¼š</strong>{{ group.task1.brewing_duration or 'æœªå¡«å†™' }}</div>
    </div>
    
    <h3 style="margin-top: 20px;">æ„Ÿå®˜è®°å½•è¡¨æ ¼</h3>
    <table class="table" style="margin-top: 10px;">
        <thead>
            <tr>
                <th></th>
                <th>è‰²æ³½(è§‚çœ‹)</th>
                <th>é¦™æ°”(è½»å—…)</th>
                <th>å½¢çŠ¶(è§‚çœ‹)</th>
                <th>æ»‹å‘³(å“å°)</th>
            </tr>
        </thead>
        <tbody>
            {% set records = group.task1.get_sensory_records() %}
            <tr>
                <td><strong>å¹²èŒ¶</strong></td>
                <td>{{ records.get('dryTea', {}).get('color', '') }}</td>
                <td>{{ records.get('dryTea', {}).get('aroma', '') }}</td>
                <td>{{ records.get('dryTea', {}).get('shape', '') }}</td>
                <td>{{ records.get('dryTea', {}).get('taste', '') }}</td>
            </tr>
            <tr>
                <td><strong>èŒ¶æ±¤</strong></td>
                <td>{{ records.get('teaLiquor', {}).get('color', '') }}</td>
                <td>{{ records.get('teaLiquor', {}).get('aroma', '') }}</td>
                <td>{{ records.get('teaLiquor', {}).get('shape', '') }}</td>
                <td>{{ records.get('teaLiquor', {}).get('taste', '') }}</td>
            </tr>
            <tr>
                <td><strong>å¶åº•</strong></td>
                <td>{{ records.get('spentLeaves', {}).get('color', '') }}</td>
                <td>{{ records.get('spentLeaves', {}).get('aroma', '') }}</td>
                <td>{{ records.get('spentLeaves', {}).get('shape', '') }}</td>
                <td>{{ records.get('spentLeaves', {}).get('taste', '') }}</td>
            </tr>
        </tbody>
    </table>
    
    {% if group.task1.reflection_answer %}
    <h3 style="margin-top: 20px;">æ€è€ƒé¢˜ç­”æ¡ˆ</h3>
    <div style="margin-top: 10px; padding: 15px; background-color: #F5F5F5; border-radius: 8px; white-space: pre-wrap;">
        {{ group.task1.reflection_answer }}
    </div>
    {% endif %}
    
    {% set task1_photos = group.photos | selectattr('photo_type', 'equalto', 'task1') | list %}
    {% if task1_photos %}
    <h3 style="margin-top: 20px;">ç…§ç‰‡</h3>
    <div style="display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px;">
        {% for photo in task1_photos %}
        <img src="/static/photos/{{ photo.file_name }}" alt="ç…§ç‰‡" style="max-width: 200px; max-height: 200px; border-radius: 8px; cursor: pointer;" onclick="window.open(this.src)">
        {% endfor %}
    </div>
    {% endif %}
</div>
{% endif %}

{% if group.task2 %}
<div class="card">
    <h2>ä»»åŠ¡äºŒï¼šæ³¡å‡ºä½ å¿ƒä¸­çš„é‚£æ¯èŒ¶</h2>
    
    <h3 style="margin-top: 20px;">èŒ¶å“ä¿¡æ¯</h3>
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 10px;">
        <div><strong>èŒ¶å“åï¼š</strong>{{ group.task2.tea_name or 'æœªå¡«å†™' }}</div>
        <div><strong>æ°´æ¸©ï¼š</strong>{{ group.task2.water_temperature or 'æœªå¡«å†™' }}</div>
        <div><strong>å‡ºæ±¤æ—¶é•¿ï¼š</strong>{{ group.task2.steeping_duration or 'æœªå¡«å†™' }}</div>
    </div>
    
    <h3 style="margin-top: 20px;">èŒ¶æ±¤ç‰¹ç‚¹</h3>
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 10px;">
        <div><strong>è‰²æ³½ï¼š</strong>{{ group.task2.tea_color or 'æœªå¡«å†™' }}</div>
        <div><strong>é¦™æ°”ï¼š</strong>{{ group.task2.tea_aroma or 'æœªå¡«å†™' }}</div>
        <div><strong>æ»‹å‘³ï¼š</strong>{{ group.task2.tea_taste or 'æœªå¡«å†™' }}</div>
    </div>
    
    <h3 style="margin-top: 20px;">æ˜¯å¦ç¬¦åˆé¢„æœŸ</h3>
    <div style="margin-top: 10px;">
        {% if group.task2.meets_expectation %}
        <span style="padding: 8px 16px; background-color: #4CAF50; color: white; border-radius: 6px; margin-right: 10px;">âœ“ ç¬¦åˆé¢„æœŸ</span>
        {% endif %}
        {% if group.task2.not_meets_expectation %}
        <span style="padding: 8px 16px; background-color: #F44336; color: white; border-radius: 6px;">âœ“ ä¸ç¬¦åˆé¢„æœŸ</span>
        {% endif %}
    </div>
    
    {% if group.task2.reflection_answer %}
    <h3 style="margin-top: 20px;">æ€è€ƒé¢˜ç­”æ¡ˆ</h3>
    <div style="margin-top: 10px; padding: 15px; background-color: #F5F5F5; border-radius: 8px; white-space: pre-wrap;">
        {{ group.task2.reflection_answer }}
    </div>
    {% endif %}
    
    {% set task2_photos = group.photos | selectattr('photo_type', 'equalto', 'task2') | list %}
    {% if task2_photos %}
    <h3 style="margin-top: 20px;">ç…§ç‰‡</h3>
    <div style="display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px;">
        {% for photo in task2_photos %}
        <img src="/static/photos/{{ photo.file_name }}" alt="ç…§ç‰‡" style="max-width: 200px; max-height: 200px; border-radius: 8px; cursor: pointer;" onclick="window.open(this.src)">
        {% endfor %}
    </div>
    {% endif %}
</div>
{% endif %}

{% for thinking in group.thinking_questions %}
<div class="card">
    <h2>
        {% if thinking.question_type == 'thinking1' %}æ€è€ƒé¢˜ä¸€
        {% elif thinking.question_type == 'thinking2' %}æ€è€ƒé¢˜äºŒ
        {% elif thinking.question_type == 'creative' %}åˆ›æ„é¢˜
        {% else %}{{ thinking.question_type }}{% endif %}
    </h2>
    
    {% if thinking.answer %}
    <div style="margin-top: 15px; padding: 15px; background-color: #F5F5F5; border-radius: 8px; white-space: pre-wrap;">
        {{ thinking.answer }}
    </div>
    {% endif %}
    
    {% set thinking_photos = group.photos | selectattr('photo_type', 'equalto', thinking.question_type) | list %}
    {% if thinking_photos %}
    <h3 style="margin-top: 20px;">ç…§ç‰‡</h3>
    <div style="display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px;">
        {% for photo in thinking_photos %}
        <img src="/static/photos/{{ photo.file_name }}" alt="ç…§ç‰‡" style="max-width: 200px; max-height: 200px; border-radius: 8px; cursor: pointer;" onclick="window.open(this.src)">
        {% endfor %}
    </div>
    {% endif %}
</div>
{% endfor %}

{% set chat_messages = group.chat_messages | sort(attribute='message_index') %}
{% if chat_messages %}
<div class="card">
    <h2>èŒ¶åŠ©æ•™é—®ç­”è®°å½•</h2>
    
    <div style="margin-top: 15px; padding: 15px; background-color: #F3E5F5; border-radius: 8px;">
        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; text-align: center;">
            <div>
                <div style="font-size: 28px; font-weight: bold; color: #9C27B0;">{{ chat_messages | length }}</div>
                <div style="color: #666; margin-top: 5px;">å¯¹è¯æ€»æ•°</div>
            </div>
            <div>
                <div style="font-size: 28px; font-weight: bold; color: #2196F3;">
                    {{ chat_messages | selectattr('role', 'equalto', 'user') | list | length }}
                </div>
                <div style="color: #666; margin-top: 5px;">å­¦ç”Ÿæé—®</div>
            </div>
            <div>
                <div style="font-size: 28px; font-weight: bold; color: #4CAF50;">
                    {{ chat_messages | selectattr('role', 'equalto', 'assistant') | list | length }}
                </div>
                <div style="color: #666; margin-top: 5px;">AIå›ç­”</div>
            </div>
        </div>
    </div>
    
    <h3 style="margin-top: 25px;">å­¦ç”Ÿæé—®åˆ—è¡¨</h3>
    <div style="margin-top: 10px;">
        {% set user_messages = chat_messages | selectattr('role', 'equalto', 'user') | list %}
        {% if user_messages %}
            <ol style="padding-left: 25px;">
                {% for msg in user_messages %}
                <li style="margin-bottom: 12px; padding: 10px; background-color: #F5F5DC; border-radius: 6px;">
                    <div style="color: #333; line-height: 1.6;">{{ msg.content }}</div>
                </li>
                {% endfor %}
            </ol>
        {% else %}
            <div style="color: #999; padding: 15px; text-align: center;">æš‚æ— å­¦ç”Ÿæé—®</div>
        {% endif %}
    </div>
    
    <h3 style="margin-top: 25px;">å®Œæ•´å¯¹è¯è®°å½•</h3>
    <div style="margin-top: 15px;">
        {% for msg in chat_messages %}
        <div style="margin-bottom: 15px;">
            {% if msg.role == 'user' %}
            <!-- å­¦ç”Ÿæé—® -->
            <div style="display: flex; justify-content: flex-end; margin-bottom: 10px;">
                <div style="max-width: 70%; background-color: #E8F5E9; padding: 12px 16px; border-radius: 12px; border-bottom-right-radius: 4px;">
                    <div style="font-weight: bold; color: #2E7D32; margin-bottom: 5px; font-size: 13px;">ğŸ‘¤ å­¦ç”Ÿ</div>
                    <div style="color: #333; line-height: 1.6; white-space: pre-wrap;">{{ msg.content }}</div>
                </div>
            </div>
            {% else %}
            <!-- AIå›ç­” -->
            <div style="display: flex; justify-content: flex-start; margin-bottom: 10px;">
                <div style="max-width: 85%; background-color: #F3E5F5; padding: 12px 16px; border-radius: 12px; border-bottom-left-radius: 4px;">
                    <div style="font-weight: bold; color: #7B1FA2; margin-bottom: 5px; font-size: 13px;">ğŸ¤– èŒ¶åŠ©æ•™</div>
                    <div style="color: #333; line-height: 1.8; white-space: pre-wrap;">{{ msg.content }}</div>
                </div>
            </div>
            {% endif %}
        </div>
        {% endfor %}
    </div>
</div>
{% endif %}

<div style="margin-top: 20px; display: flex; gap: 10px;">
    <a href="/" class="btn">è¿”å›åˆ—è¡¨</a>
    <button onclick="deleteStudent('{{ group.submission_id }}', '{{ group.school }} - {{ group.grade }}{{ group.class_number }}ç­')" 
            class="btn btn-danger">
        åˆ é™¤æ•°æ®
    </button>
</div>
{% endblock %}

