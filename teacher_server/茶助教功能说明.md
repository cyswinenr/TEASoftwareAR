# 茶助教问答功能 - 完整使用说明

## 📋 功能概述

本次更新为茶文化课程系统添加了**茶助教问答记录**功能，让教师能够查看学生在使用茶助教时的所有提问和AI回答记录。

## 🎯 功能特点

### 学生端（Pad App）
- ✅ 学生可以随时向茶助教提问茶文化相关问题
- ✅ 所有对话记录自动保存到本地和云端
- ✅ 提交数据时，茶助教问答记录会一并提交到服务器

### 教师端（Web管理后台）
- ✅ 查看每个小组的茶助教对话记录
- ✅ 统计数据展示（对话总数、学生提问数、AI回答数）
- ✅ 学生提问列表展示
- ✅ 完整对话记录展示（聊天气泡形式）

---

## 🚀 部署步骤

### 第一步：运行数据库迁移

**在服务器上执行以下操作之一：**

#### 方法1：使用批处理文件（推荐）
双击运行：`迁移数据库-添加茶助教表.bat`

#### 方法2：使用Python命令
```bash
python add_chat_messages_table.py
```

**预期输出：**
```
============================================================
茶文化课程 - 数据库迁移脚本
添加茶助教问答记录表
============================================================

正在创建表 chat_messages...
✓ 表 chat_messages 创建成功！
✓ 数据库迁移完成！

表结构:
------------------------------------------------------------
  id                   INTEGER
  group_id             INTEGER
  message_index        INTEGER
  role                 VARCHAR(20)
  content              TEXT
  submit_time          DATETIME
------------------------------------------------------------

✓ 迁移完成！服务器现在可以接收和存储茶助教问答记录。
```

### 第二步：重启服务器

如果服务器正在运行，需要重启以加载新代码：

1. 停止当前运行的服务器（Ctrl+C）
2. 重新运行：`python run.py` 或双击 `启动服务器.bat`

### 第三步：验证功能

1. 在Pad端登录并向茶助教提问几个问题
2. 提交数据到服务器
3. 在教师端查看该学生的详情页面
4. 应该能看到"茶助教问答记录"板块

---

## 📊 数据结构说明

### 数据库表：`chat_messages`

| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | INTEGER | 主键，自增 |
| group_id | INTEGER | 关联学生组ID |
| message_index | INTEGER | 消息序号（按对话顺序） |
| role | VARCHAR(20) | 角色：'user'(学生) 或 'assistant'(AI) |
| content | TEXT | 消息内容 |
| submit_time | DATETIME | 提交时间 |

### API数据格式

**前端提交格式：**
```json
{
  "studentInfo": { ... },
  "task1": { ... },
  "task2": { ... },
  "chatHistory": [
    {
      "role": "user",
      "content": "茶叶有哪些种类？"
    },
    {
      "role": "assistant",
      "content": "茶叶主要分为六大类：绿茶、红茶、乌龙茶..."
    }
  ]
}
```

**后端返回格式（学生详情API）：**
```json
{
  "success": true,
  "data": {
    "chat_messages": [
      {
        "id": 1,
        "message_index": 0,
        "role": "user",
        "content": "茶叶有哪些种类？",
        "submit_time": "2025-12-31T10:30:00"
      },
      {
        "id": 2,
        "message_index": 1,
        "role": "assistant",
        "content": "茶叶主要分为六大类...",
        "submit_time": "2025-12-31T10:30:00"
      }
    ],
    "user_questions_count": 5
  }
}
```

---

## 🎨 教师端展示效果

### 1. 统计信息卡片
```
┌──────────────────────────────────────┐
│   对话总数    学生提问    AI回答     │
│      10         5          5         │
└──────────────────────────────────────┘
```

### 2. 学生提问列表
```
1. 茶叶有哪些种类？
2. 绿茶和红茶有什么区别？
3. 如何判断茶叶的好坏？
...
```

### 3. 完整对话记录（聊天气泡形式）
```
                    ┌──────────────────┐
                    │ 👤 学生          │
                    │ 茶叶有哪些种类？ │
                    └──────────────────┘

┌──────────────────────────────────────┐
│ 🤖 茶助教                            │
│ 茶叶主要分为六大类：绿茶、红茶... │
└──────────────────────────────────────┘
```

---

## 🔧 技术实现细节

### 前端（Kotlin/Android）
- **文件：** `DataSubmissionService.kt`
- **功能：** 收集并提交茶助教问答数据
- **关键代码：**
```kotlin
// 茶助教记录
val chatHistoryManager = ChatHistoryManager(context)
val chatHistory = chatHistoryManager.getChatHistoryAsJson()
json.put("chatHistory", chatHistory)
```

### 后端（Python/Flask）
- **模型文件：** `models.py` - 添加 `ChatMessage` 模型
- **服务文件：** `data_service.py` - 添加 `save_chat_messages()` 函数
- **路由文件：** `web.py` - 修改详情API返回茶助教数据
- **模板文件：** `student_detail.html` - 展示茶助教问答记录

---

## ❓ 常见问题

### Q1: 迁移脚本显示"表已存在"怎么办？
**A:** 这是正常的，说明表已经创建过了，无需再次运行迁移。

### Q2: 教师端看不到茶助教记录？
**A:** 请检查：
1. 学生是否在Pad端使用过茶助教功能
2. 学生是否提交了数据到服务器
3. 数据库迁移是否成功执行
4. 服务器是否已重启

### Q3: 如何删除旧的问答记录？
**A:** 茶助教记录与学生组数据绑定，删除学生数据时会自动级联删除相关的茶助教记录。

### Q4: 问答记录的存储容量有限制吗？
**A:** 
- 单条消息内容使用TEXT类型，理论上可以存储最多2GB的内容
- 消息数量没有硬性限制，但建议单个学生组不超过1000条对话
- 如果对话记录过多，可能影响页面加载速度

---

## 📝 更新日志

### v2.0 - 2025-12-31
- ✅ 添加茶助教问答记录功能
- ✅ 创建 `chat_messages` 数据库表
- ✅ 前端支持提交茶助教对话数据
- ✅ 后端接收并存储茶助教对话数据
- ✅ 教师端展示茶助教问答记录
- ✅ 提供数据库迁移脚本

---

## 📞 技术支持

如有问题，请联系技术支持团队。

**祝使用愉快！** 🎉

